{% extends 'dash.html' %}

{% block title %}Invoice Reports{% endblock %}

{% load humanize %}
{% block content %}
<div class="w-full h-[87vh] bg-gray-900 overflow-auto mb-4">
    <div class="mx-auto max-w-7xl">
        <h1 class="text-3xl font-bold mb-6 text-blue-500">Invoice Reports</h1>

        <!-- Filter Form -->
        <form method="GET" class="space-y-4">
            <!-- Date Filter -->
            <div>
                <label for="date_filter" class="block text-sm font-medium leading-6 text-blue-500">Date Filter</label>
                <select id="date_filter" name="date_filter"
                    class="mt-2 block w-full rounded-md border-0 py-1.5 pl-3 pr-10 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 sm:text-sm sm:leading-6">
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                    <option value="yearly">Yearly</option>
                    <option value="custom">Custom Date Range</option>
                </select>
            </div>

            <!-- Custom Date Range -->
            <div id="custom-date-range" class="hidden">
                <label for="start_date" class="block text-sm font-medium leading-6 text-blue-500">Start Date</label>
                <input type="date" id="start_date" name="start_date"
                    class="mt-2 block w-full rounded-md border-0 py-1.5 pl-3 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 sm:text-sm sm:leading-6">

                <label for="end_date" class="block text-sm font-medium leading-6 text-gray-900 mt-4">End Date</label>
                <input type="date" id="end_date" name="end_date"
                    class="mt-2 block w-full rounded-md border-0 py-1.5 pl-3 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 sm:text-sm sm:leading-6">
            </div>

            <!-- Payment Status Filter -->
            <div>
                <label for="payment_status" class="block text-sm font-medium leading-6 text-blue-500">Payment
                    Status</label>
                <select id="payment_status" name="payment_status"
                    class="mt-2 block w-full rounded-md border-0 py-1.5 pl-3 pr-10 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 sm:text-sm sm:leading-6">
                    <option value="">All</option>
                    <option value="paid">Paid</option>
                    <option value="unpaid">Unpaid</option>
                </select>
            </div>

            <!-- Client Filter -->
            <div>
                <label for="client" class="block text-sm font-medium leading-6 text-blue-500">Client</label>
                <select id="client" name="client"
                    class="mt-2 block w-full rounded-md border-0 py-1.5 pl-3 pr-10 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 sm:text-sm sm:leading-6">
                    <option value="">All Clients</option>
                    {% for client in clients %}
                    <option value="{{ client.client_id }}">{{ client.client_name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Company Filter -->
            <div>
                <label for="company" class="block text-sm font-medium leading-6 text-blue-500">Company</label>
                <select id="company" name="company"
                    class="mt-2 block w-full rounded-md border-0 py-1.5 pl-3 pr-10 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 sm:text-sm sm:leading-6">
                    <option value="">All Companies</option>
                    {% for company in companies %}
                    <option value="{{ company.company_id }}">{{ company.company_name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Submit Button -->
            <button type="submit"
                class="mt-4 bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 focus:outline-none">Filter</button>
        </form>
        </form>

        <!-- Invoice Table -->
        <h2 class="text-2xl font-bold mt-10 text-blue-500">Filtered Invoices</h2>
        <table class="min-w-full table-auto mt-4 border-collapse border border-gray-300">
            <thead>
                <tr class="bg-gray-200 text-left text-indigo-600">
                    <th class="px-4 py-2 border">Invoice ID</th>
                    <th class="px-4 py-2 border">Client</th>
                    <th class="px-4 py-2 border">Amount</th>
                    <th class="px-4 py-2 border">Paid</th>
                    <th class="px-4 py-2 border">Due Date</th>
                    <th class="px-4 py-2 border">Company</th>
                </tr>
            </thead>
            <tbody>
                {% for invoice in invoices %}
                <tr class="border-t text-white">
                    <td class="px-4 py-2 border">{{ invoice.id }}</td>
                    <td class="px-4 py-2 border">{{ invoice.client.client_name }}</td>
                    <td class="px-4 py-2 border">KSH. {{ invoice.total_cost |intcomma }}</td>
                    <td class="px-4 py-2 border">{{ invoice.paid }}</td>
                    <td class="px-4 py-2 border">{{ invoice.due_date }}</td>
                    <td class="px-4 py-2 border">{{ invoice.client.client_company_name }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Pie Chart Section -->
        <div class="mt-10">
            <h2 class="text-2xl font-bold text-blue-500">Paid vs Unpaid Invoices</h2>
            <canvas id="invoicePieChart" width="400" height="400"></canvas>
        </div>
    </div>
</div>

<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Script to handle date range and render the pie chart -->
<script>
    const dateFilter = document.getElementById('date_filter');
    const customDateRange = document.getElementById('custom-date-range');
    dateFilter.addEventListener('change', function () {
        if (this.value === 'custom') {
            customDateRange.classList.remove('hidden');
        } else {
            customDateRange.classList.add('hidden');
        }
    });

    // Render the Pie Chart using Chart.js
    const ctx = document.getElementById('invoicePieChart').getContext('2d');

    // Use Django variables for chart data
    const totalPaidAmount = {{ total_paid_amount|default:0 }};
    const totalUnpaidAmount = {{ total_unpaid_amount|default:0 }};

    const invoicePieChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Paid Invoices', 'Unpaid Invoices'],
            datasets: [{
                label: 'Invoice Amount',
                data: [totalPaidAmount, totalUnpaidAmount],
                backgroundColor: ['#4CAF50', '#FF5733'],
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let value = context.raw;
                            return 'Amount: KSH ' + value.toFixed(2);
                        }
                    }
                }
            }
        }
    });
</script>
{% endblock %}